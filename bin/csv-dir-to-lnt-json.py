#!/usr/bin/python

import datetime
import os
import subprocess

# Only run this in a directory full of CSV-s generated by the CSiBE backend.

default_start_time_str = "01:00:00"
default_end_time_str = "01:01:00"

default_start_time = datetime.datetime.strptime(default_start_time_str, '%H:%M:%S')
default_end_time = datetime.datetime.strptime(default_end_time_str, '%H:%M:%S')

filenames_by_date = {}

for root, dirs, files in os.walk(".", topdown=False):
    for name in files:
        file_date = name[:10]
        if name[-3:] == "csv":
            if file_date in filenames_by_date: 
                filenames_by_date[file_date].append(name)
            else:
                filenames_by_date[file_date] = [name]

for key, value in filenames_by_date.iteritems():
    minutes_delta = 0
    for filename in sorted(value):
        current_start_time = default_start_time + datetime.timedelta(minutes=minutes_delta)
        current_start_time_str = current_start_time.strftime('%H:%M:%S')

        current_end_time = default_end_time + datetime.timedelta(minutes=minutes_delta)
        current_end_time_str = current_end_time.strftime('%H:%M:%S')

        subprocess.call(['python', 'csibe_csv_to_lnt_json.py', '--json-path', (filename + ".json"), '--csv-path', filename, '--start-time', current_start_time_str, '--end-time', current_end_time_str])

        minutes_delta = minutes_delta + 2

